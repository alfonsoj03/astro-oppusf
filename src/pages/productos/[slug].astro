---
import Layout from "../../layouts/Layout.astro";
import ProductDetail from "../../components/ProductDetail.astro";
import placeholderImage from "@/assets/OPP-80W-ST.png";
import { supabase } from "../../lib/supabase";

export async function getStaticPaths() {
    // Fetch all products
    const { data: products, error: productsError } = await supabase
        .from('products')
        .select('*');

    if (productsError) {
        console.error("Error fetching products:", productsError);
        return [];
    }

    // Fetch all categories
    const { data: categories, error: categoriesError } = await supabase
        .from('product_categories')
        .select('*');
    
    if (categoriesError) {
        console.error("Error fetching categories:", categoriesError);
    }

    // Fetch all specs
    const { data: specs, error: specsError } = await supabase
        .from('product_specs')
        .select('*');

    if (specsError) {
        console.error("Error fetching specs:", specsError);
    }

    // Fetch all files
    const { data: files, error: filesError } = await supabase
        .from('product_files')
        .select('*');

    if (filesError) {
        console.error("Error fetching files:", filesError);
    }

    return products.map((product) => {
        const category = categories?.find(c => c.id === product.category_id);
        const productSpecs = specs?.filter(s => s.product_id === product.id) || [];
        const productFiles = files?.filter(f => f.product_id === product.id) || [];

        return {
            params: { slug: product.slug },
            props: { 
                product,
                categoryName: category?.name || "Unknown Category",
                specs: productSpecs,
                files: productFiles
            },
        };
    });
}

const { slug } = Astro.params;
const { product, categoryName, specs, files } = Astro.props;

const productData = {
    category: categoryName,
    slug: product.slug,
    title: product.name,
    seriesTitle: product.led_power ? `${product.led_power}` : "", // RDX -> Watts
    seriesSubtitle: product.efficiency ? `${product.efficiency}` : "", // ROUND MAX SERIES -> Eficiencia
    description: product.description_short || "",
    previousModel: "PEL-K", // Placeholder
    image: placeholderImage.src, // Placeholder
    versions: [ // Dummy data
        { id: "1", name: "BRACKET 63W-83", gtin: "4096854203689" },
        { id: "2", name: "BRACKET 63W-85", gtin: "4096854203690" },
        { id: "3", name: "BRACKET 63W-87", gtin: "4096854203691" },
    ],
    specifications: specs.map(s => ({
        label: s.label,
        value: s.value
    })),
    downloads: files.map(f => ({
        title: f.file_title,
        url: f.file_path
    })),
    technicalDescription: [
        product.description_long || ""
    ],
    technicalImages: [ // Placeholder
        {
            title: "Dimensiones (mm)",
            image: "https://images.unsplash.com/photo-1764737734436-7eb904d3a4ab?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&q=80&w=400",
        },
        {
            title: "Diseño",
            image: "https://images.unsplash.com/photo-1740660281156-435ce0cc1aff?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&q=80&w=400",
        },
        {
            title: "Curva de Distribución",
            image: "https://images.unsplash.com/photo-1717501217912-933d2792d493?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&q=80&w=400",
        },
        {
            title: "Certificaciones",
            image: "https://images.unsplash.com/photo-1730692504752-c411cf0306ac?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&q=80&w=400",
        },
    ],
};
---

<Layout headerTheme="black">
    <ProductDetail {...productData} />
</Layout>

