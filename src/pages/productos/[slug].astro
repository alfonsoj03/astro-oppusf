---
import Layout from "../../layouts/Layout.astro";
import ProductDetail from "../../components/ProductDetail.astro";
import placeholderImage from "@/assets/OPP-80W-ST.png";
import { supabase } from "../../lib/supabase";

// Import all images from assets directory
const images = import.meta.glob<{ default: ImageMetadata }>(
    "/src/assets/*.{png,jpg,jpeg,webp}",
    { eager: true },
);

export async function getStaticPaths() {
    // Fetch all products
    const { data: products, error: productsError } = await supabase
        .from("products")
        .select("*");

    if (productsError) {
        console.error("Error fetching products:", productsError);
        return [];
    }

    // Fetch all categories
    const { data: categories, error: categoriesError } = await supabase
        .from("product_categories")
        .select("*");

    if (categoriesError) {
        console.error("Error fetching categories:", categoriesError);
    }

    // Fetch all specs
    const { data: specs, error: specsError } = await supabase
        .from("product_specs")
        .select("*");

    if (specsError) {
        console.error("Error fetching specs:", specsError);
    }

    // Fetch all files
    const { data: files, error: filesError } = await supabase
        .from("product_files")
        .select("*");

    if (filesError) {
        console.error("Error fetching files:", filesError);
    }

    // Fetch all technical images
    const { data: technicalImages, error: techImagesError } = await supabase
        .from("product_images")
        .select("*");

    if (techImagesError) {
        console.error("Error fetching technical images:", techImagesError);
    }

    return products.map((product) => {
        const category = categories?.find((c) => c.id === product.category_id);
        const productSpecs =
            specs?.filter((s) => s.product_id === product.id) || [];
        const productFiles =
            files?.filter((f) => f.product_id === product.id) || [];
        const productTechImages =
            technicalImages?.filter((ti) => ti.product_id === product.id) || [];

        return {
            params: { slug: product.slug },
            props: {
                product,
                categoryName: category?.name || "Unknown Category",
                specs: productSpecs,
                files: productFiles,
                techImages: productTechImages,
            },
        };
    });
}

const { slug } = Astro.params;
const { product, categoryName, specs, files, techImages } = Astro.props;

// Helper to resolve image from glob
function resolveImage(imageName: string | null, suffix: string = "") {
    if (!imageName) return placeholderImage.src;
    if (imageName.startsWith("http")) return imageName;

    const imagePath = `/src/assets/${imageName}${suffix}.png`;
    const imageModule = images[imagePath];

    if (imageModule && imageModule.default) {
        return imageModule.default.src;
    }

    return placeholderImage.src;
}

const productData = {
    category: categoryName,
    slug: product.slug,
    title: product.name,
    seriesTitle: product.led_power ? `${product.led_power}` : "", // RDX -> Watts
    seriesSubtitle: product.efficiency ? `${product.efficiency}` : "", // ROUND MAX SERIES -> Eficiencia
    description: product.description_short || "",
    previousModel: "PEL-K", // Placeholder
    image: resolveImage(product.main_image, "-main"),
    specifications: specs.map((s) => ({
        label: s.label,
        value: s.value,
    })),
    downloads: files.map((f) => ({
        title: f.file_title,
        url: f.file_path,
    })),
    technicalDescription: [product.description_long || ""],
    technicalImages: techImages.map((ti) => ({
        title: ti.image_title,
        image: resolveImage(ti.image_name),
    })),
};
---

<Layout headerTheme="black">
    <ProductDetail {...productData} />
</Layout>
