---
import { X, Minus, Plus } from "lucide-astro";

import productsData from "../data/products.json";

---

<section class="bg-white pb-12 pt-32">
    <div class="max-w-7xl mx-auto px-6">

        {/* Breadcrumb */}
        <div
            class="flex items-center gap-3 text-zinc-500 text-xs uppercase tracking-widest mb-6"
        >
            <span>Inicio</span>
            <span class="text-[#FF8351]">/</span>
            <span class="text-[#FF8351]">Productos</span>
        </div>

        {/* Header: Shopping Cart Title */}
        <div class="mb-8 flex items-end justify-between">
            <div>
                <h2
                    class="text-4xl font-bold tracking-tight text-black leading-none mb-2"
                >
                    Solicitar Cotización
                </h2>
                <div class="h-1 w-16 bg-[#FF8351]"></div>
            </div>
            <div class="text-zinc-500 text-sm max-w-xs text-right pb-2 hidden md:block">
                Haznos llegar tu cotización escribiendo un mensaje en el formulario
                de abajo.
            </div>
        </div>

        {/* Cart Items */}
        <div class="space-y-4 mb-12" id="cart-items-container">
            {/* Cart Items will be rendered here by JS */}
            <div id="empty-cart-message" class="hidden text-center py-12 text-zinc-500">
                Tu carrito de cotización está vacío.
            </div>
        </div>

        {/* Contact Form */}
        <div>

            <form id="quote-form" class="bg-zinc-50 p-8">
                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    {/* Nombre */}
                    <div>
                        <label
                            for="name"
                            class="block text-sm text-zinc-600 mb-2"
                        >
                            Nombre
                        </label>
                        <input
                            type="text"
                            id="name"
                            name="name"
                            placeholder="Tu nombre completo"
                            required
                            class="w-full px-4 py-3 bg-white border border-zinc-200 rounded text-black placeholder-zinc-400 focus:outline-none focus:border-[#FF8351] transition-colors"
                        />
                    </div>

                    {/* Email */}
                    <div>
                        <label
                            for="email"
                            class="block text-sm text-zinc-600 mb-2"
                        >
                            Email
                        </label>
                        <input
                            type="email"
                            id="email"
                            name="email"
                            placeholder="nombre@empresa.com"
                            required
                            class="w-full px-4 py-3 bg-white border border-zinc-200 rounded text-black placeholder-zinc-400 focus:outline-none focus:border-[#FF8351] transition-colors"
                        />
                    </div>

                    {/* Teléfono */}
                    <div>
                        <label
                            for="phone"
                            class="block text-sm text-zinc-600 mb-2"
                        >
                            Teléfono de Contacto
                        </label>
                        <input
                            type="tel"
                            id="phone"
                            name="phone"
                            placeholder="81 1234 5678"
                            required
                            class="w-full px-4 py-3 bg-white border border-zinc-200 rounded text-black placeholder-zinc-400 focus:outline-none focus:border-[#FF8351] transition-colors"
                        />
                    </div>

                    {/* País */}
                    <div>
                        <label
                            for="country"
                            class="block text-sm text-zinc-600 mb-2"
                        >
                            País de Contacto
                        </label>
                        <select
                            id="country"
                            name="country"
                            required
                            class="w-full px-4 py-3 bg-white border border-zinc-200 rounded text-black focus:outline-none focus:border-[#FF8351] transition-colors"
                        >
                            <option value="">Selecciona tu país</option>
                            <option value="MX">México</option>
                            <option value="CO">Colombia</option>
                            <option value="US">Estados Unidos</option>
                            <option value="CA">Canadá</option>
                            <option value="other">Otro</option>
                        </select>
                    </div>
                </div>

                {/* Campo condicional para especificar país */}
                <div id="other-country-container" class="hidden mb-6">
                    <label
                        for="other-country"
                        class="block text-sm text-zinc-600 mb-2"
                    >
                        Especifica tu país
                    </label>
                    <input
                        type="text"
                        id="other-country"
                        name="other-country"
                        placeholder="Escribe tu país"
                        class="w-full px-4 py-3 bg-white border border-zinc-200 rounded text-black placeholder-zinc-400 focus:outline-none focus:border-[#FF8351] transition-colors"
                    />
                </div>

                {/* Mensaje */}
                <div class="mb-2">
                    <label
                        for="message"
                        class="block text-sm text-zinc-600 mb-2"
                    >
                        Mensaje
                    </label>
                    <textarea
                        id="message"
                        name="message"
                        rows="6"
                        required
                        class="w-full px-4 py-3 bg-white border border-zinc-200 rounded text-black placeholder-zinc-400 focus:outline-none focus:border-[#FF8351] transition-colors resize-none"
                        >Quiero hacer una cotización con respecto a los productos en mi carrito...</textarea
                    >
                </div>

            </form>

            <div class="flex flex-col md:flex-row justify-between items-center mt-8 gap-4">
                <div class="flex items-center gap-2 text-zinc-400 text-sm">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        class="lucide lucide-lock"
                        ><rect width="18" height="11" x="3" y="11" rx="2" ry="2"
                        ></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg
                    >
                    <span>Tus datos están protegidos</span>
                </div>
                <button
                    type="submit"
                    form="quote-form"
                    class="w-full md:w-auto px-12 py-3 bg-[#FF8351] text-white font-bold uppercase tracking-wider text-sm hover:bg-[#ff6f38] transition-colors"
                >
                    Enviar Cotización
                </button>
            </div>
        </div>
    </div>
</section>

<script define:vars={{ productsData }}>
    // Pass products to client
    const products = productsData;

    const cartContainer = document.getElementById("cart-items-container");
    const emptyMessage = document.getElementById("empty-cart-message");
    const cartCount = document.getElementById("cart-count");

    // Icons SVG strings for dynamic rendering
    const minusIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M5 12h14"/></svg>`;
    const plusIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M5 12h14"/><path d="M12 5v14"/></svg>`;
    const xIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>`;

    function renderCart() {
        if (!cartContainer) return;
        
        const cart = JSON.parse(localStorage.getItem('opplux_cart') || '[]');
        
        if (cart.length === 0) {
            cartContainer.innerHTML = '';
            if (emptyMessage) {
                cartContainer.appendChild(emptyMessage);
                emptyMessage.classList.remove('hidden');
            }
            return;
        }

        if (emptyMessage) emptyMessage.classList.add('hidden');
        cartContainer.innerHTML = '';

        cart.forEach((item) => {
            const product = products.find((p) => p.slug === item.slug);
            if (!product) return;

            // Image logic: use main_image or fallback
            const imageName = product.main_image || 'placeholder';
            const imageUrl = `/imgs/cart/${imageName}.png`;
            const fallbackUrl = `/imgs/cart/no-image.png`;

            const itemEl = document.createElement('div');
            itemEl.className = "cart-item bg-zinc-50 border border-zinc-200 p-6 md:p-4 lg:p-6 flex items-center gap-8 hover:border-[#FF8351]/50 transition-all duration-300";
            itemEl.dataset.slug = item.slug;

            itemEl.innerHTML = `
                <div class="w-20 h-20 bg-white rounded overflow-hidden flex-shrink-0">
                    <img
                        src="${imageUrl}"
                        alt="${product.name}"
                        class="w-full h-full object-cover"
                        onerror="this.onerror=null; this.src='${fallbackUrl}';"
                    />
                </div>

                <div class="flex-1">
                    <h3 class="text-black font-bold uppercase tracking-wide leading-tight mb-1">
                        ${product.name}
                    </h3>
                    <p class="text-xs text-zinc-400">${product.led_power || ''}</p>
                </div>

                <div class="min-w-[100px]">
                    <p class="text-xs text-zinc-400 mb-1">
                        Flujo luminoso
                    </p>
                    <p class="text-black font-bold text-sm">
                        ${product.max_luminous_flux}
                    </p>
                </div>

                <div class="min-w-[100px] md:min-w-[80px] lg:min-w-[100px]">
                    <p class="text-xs text-zinc-400 mb-1">Garantía</p>
                    <p class="text-black font-bold text-sm">
                        ${product.warranty || 'N/A'}
                    </p>
                </div>

                <div class="flex items-center gap-4 md:gap-2 lg:gap-4">
                    <button
                        class="decrease-qty w-8 h-8 rounded-full border border-zinc-300 hover:border-[#FF8351] flex items-center justify-center transition-colors text-zinc-600 hover:text-[#FF8351]"
                        aria-label="Disminuir cantidad"
                    >
                        ${minusIcon}
                    </button>
                    <span class="qty-display text-black min-w-[40px] text-center">
                        ${item.quantity}
                    </span>
                    <button
                        class="increase-qty w-8 h-8 rounded-full border border-zinc-300 hover:border-[#FF8351] flex items-center justify-center transition-colors text-zinc-600 hover:text-[#FF8351]"
                        aria-label="Aumentar cantidad"
                    >
                        ${plusIcon}
                    </button>
                </div>

                <button
                    class="remove-item w-8 h-8 rounded-full border border-zinc-300 hover:border-[#FF8351] flex items-center justify-center transition-colors text-zinc-400 hover:text-[#FF8351]"
                    aria-label="Eliminar producto"
                >
                    ${xIcon}
                </button>
            `;
            
            cartContainer.appendChild(itemEl);
        });
    }

    // Initial render
    renderCart();

    if (cartContainer) {
        cartContainer.addEventListener("click", (e) => {
            const target = e.target;
            const itemRow = target.closest(".cart-item");

            if (!itemRow) return;

            const slug = itemRow.dataset.slug;
            const qtyDisplay = itemRow.querySelector(".qty-display");
            
            // Get current cart
            let cart = JSON.parse(localStorage.getItem('opplux_cart') || '[]');
            const itemIndex = cart.findIndex((i) => i.slug === slug);
            
            if (itemIndex === -1) return;

            let currentQty = cart[itemIndex].quantity;

            // Increase Quantity
            if (target.closest(".increase-qty")) {
                currentQty++;
                cart[itemIndex].quantity = currentQty;
                if (qtyDisplay) qtyDisplay.textContent = currentQty.toString();
                localStorage.setItem('opplux_cart', JSON.stringify(cart));
            }

            // Decrease Quantity
            if (target.closest(".decrease-qty")) {
                if (currentQty > 1) {
                    currentQty--;
                    cart[itemIndex].quantity = currentQty;
                    if (qtyDisplay) qtyDisplay.textContent = currentQty.toString();
                    localStorage.setItem('opplux_cart', JSON.stringify(cart));
                }
            }

            // Remove Item
            if (target.closest(".remove-item")) {
                itemRow.style.opacity = "0";
                itemRow.style.transform = "translateX(-20px)";
                
                // Remove from cart array
                cart.splice(itemIndex, 1);
                localStorage.setItem('opplux_cart', JSON.stringify(cart));
                
                // Dispatch event to update header
                window.dispatchEvent(new CustomEvent('add-to-cart'));

                setTimeout(() => {
                    renderCart(); // Re-render to handle empty state if needed
                }, 300);
            }
        });
    }

    // Form handling
    const form = document.getElementById("quote-form");
    if (form) {
        form.addEventListener("submit", (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            console.log("Form submitted:", data);
            alert("¡Cotización enviada! (Simulación)");
        });
    }

    // Country selection handler
    const countrySelect = document.getElementById("country");
    const otherCountryContainer = document.getElementById("other-country-container");
    const otherCountryInput = document.getElementById("other-country");

    if (countrySelect && otherCountryContainer && otherCountryInput) {
        countrySelect.addEventListener("change", (e) => {
            const target = e.target;
            if (target.value === "other") {
                otherCountryContainer.classList.remove("hidden");
                otherCountryInput.required = true;
            } else {
                otherCountryContainer.classList.add("hidden");
                otherCountryInput.required = false;
                otherCountryInput.value = "";
            }
        });
    }
</script>