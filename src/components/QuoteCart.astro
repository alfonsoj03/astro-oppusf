---
import { X, Minus, Plus } from "lucide-astro";
import productsData from "../data/products.json";
import Breadcrumb from "./Breadcrumb.astro";

const initialMessage =
    "Quiero hacer una cotización con respecto a los productos en mi carrito...";

// Get all images from assets dynamically
const allImages = import.meta.glob("/src/assets/*.{png,jpg,jpeg,svg}", {
    eager: true,
});
const imageMap = Object.fromEntries(
    Object.entries(allImages).map(([path, module]) => {
        const fileName = path.split("/").pop()?.split(".")[0];
        return [fileName, (module as any).default.src];
    }),
);

const FORM_API_KEY = import.meta.env.FORM_API_KEY;

const breadcrumbItems = [
    { label: "Inicio", href: "/" },
    { label: "Cotización" },
];
---

<section class="bg-white pb-12 pt-32">
    <div class="max-w-7xl mx-auto px-6">
        {/* Breadcrumb */}
        <Breadcrumb items={breadcrumbItems} />

        {/* Header: Shopping Cart Title */}
        <div class="mb-8 flex items-end justify-between">
            <div>
                <h2
                    class="text-4xl font-bold tracking-tight text-black leading-none mb-2"
                >
                    Solicitar Cotización
                </h2>
                <div class="h-1 w-16 bg-[#FF8351]"></div>
            </div>
            <div
                class="text-zinc-500 text-sm max-w-xs text-right pb-2 hidden md:block"
            >
                Haznos llegar tu cotización escribiendo un mensaje en el
                formulario de abajo.
            </div>
        </div>

        {/* Cart Items */}
        <div class="space-y-4 mb-12" id="cart-items-container">
            {/* Cart Items will be rendered here by JS */}
            <div
                id="empty-cart-message"
                class="hidden text-center py-6 md:py-12 text-zinc-500"
            >
                Tu carrito de cotización está vacío. Añade productos para poder
                cotizar.
            </div>
        </div>

        {/* Contact Form */}
        <div>
            <form id="quote-form" class="bg-zinc-50 p-8">
                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    {/* Nombre */}
                    <div class="flex flex-col">
                        <label
                            for="name"
                            class="block text-sm text-zinc-600 mb-2"
                        >
                            Nombre <span class="text-red-500">*</span>
                        </label>
                        <input
                            type="text"
                            id="name"
                            name="name"
                            placeholder="Tu nombre completo"
                            class="w-full px-4 py-3 bg-white border border-zinc-200 rounded text-black placeholder-zinc-400 focus:outline-none focus:border-[#FF8351] transition-colors"
                        />
                        <p
                            id="error-name"
                            class="text-red-500 text-xs mt-1 hidden"
                        >
                        </p>
                    </div>

                    {/* Email */}
                    <div class="flex flex-col">
                        <label
                            for="email"
                            class="block text-sm text-zinc-600 mb-2"
                        >
                            Email <span class="text-red-500">*</span>
                        </label>
                        <input
                            type="email"
                            id="email"
                            name="email"
                            placeholder="nombre@empresa.com"
                            class="w-full px-4 py-3 bg-white border border-zinc-200 rounded text-black placeholder-zinc-400 focus:outline-none focus:border-[#FF8351] transition-colors"
                        />
                        <p
                            id="error-email"
                            class="text-red-500 text-xs mt-1 hidden"
                        >
                        </p>
                    </div>

                    {/* País */}
                    <div class="flex flex-col">
                        <label
                            for="country"
                            class="block text-sm text-zinc-600 mb-2"
                        >
                            País de Contacto <span class="text-red-500">*</span>
                        </label>
                        <select
                            id="country"
                            name="country"
                            class="w-full px-4 py-3 bg-white border border-zinc-200 rounded text-black focus:outline-none focus:border-[#FF8351] transition-colors"
                        >
                            <option value="">Selecciona tu país</option>
                            <option value="MX">México (+52)</option>
                            <option value="CO">Colombia (+57)</option>
                            <option value="US">Estados Unidos (+1)</option>
                            <option value="CA">Canadá (+1)</option>
                            <option value="other">Otro</option>
                        </select>
                        <p
                            id="error-country"
                            class="text-red-500 text-xs mt-1 hidden"
                        >
                        </p>
                    </div>

                    {/* Teléfono */}
                    <div class="flex flex-col">
                        <label
                            for="phone"
                            class="block text-sm text-zinc-600 mb-2"
                        >
                            Teléfono de Contacto <span class="text-red-500"
                                >*</span
                            >
                        </label>
                        <input
                            type="tel"
                            id="phone"
                            name="phone"
                            placeholder="81 1234 5678"
                            class="w-full px-4 py-3 bg-white border border-zinc-200 rounded text-black placeholder-zinc-400 focus:outline-none focus:border-[#FF8351] transition-colors"
                        />
                        <p
                            id="error-phone"
                            class="text-red-500 text-xs mt-1 hidden"
                        >
                        </p>
                    </div>
                </div>

                {/* Empresa */}
                <div class="mb-6 flex flex-col">
                    <label
                        for="company"
                        class="block text-sm text-zinc-600 mb-2"
                    >
                        Empresa <span class="text-red-500">*</span>
                    </label>
                    <input
                        type="text"
                        id="company"
                        name="company"
                        placeholder="Nombre de tu empresa"
                        class="w-full px-4 py-3 bg-white border border-zinc-200 rounded text-black placeholder-zinc-400 focus:outline-none focus:border-[#FF8351] transition-colors"
                    />
                    <p
                        id="error-company"
                        class="text-red-500 text-xs mt-1 hidden"
                    >
                    </p>
                </div>

                {/* Honeypot - Departamento (Oculto para usuarios) */}
                <div class="hidden">
                    <label for="department">Departamento</label>
                    <input
                        type="text"
                        id="department"
                        name="department"
                        tabindex="-1"
                        autocomplete="off"
                    />
                </div>

                {/* Mensaje */}
                <div class="mb-2 flex flex-col">
                    <label
                        for="message"
                        class="block text-sm text-zinc-600 mb-2"
                    >
                        Mensaje <span class="text-red-500">*</span>
                    </label>
                    <textarea
                        id="message"
                        name="message"
                        rows="6"
                        class="w-full px-4 py-3 bg-white border border-zinc-200 rounded text-black placeholder-zinc-400 focus:outline-none focus:border-[#FF8351] transition-colors resize-none"
                        >{initialMessage}</textarea
                    >
                    <p
                        id="error-message"
                        class="text-red-500 text-xs mt-1 hidden"
                    >
                    </p>
                </div>
            </form>

            <div
                class="flex flex-col md:flex-row justify-between items-center mt-8 gap-4"
            >
                <div class="flex items-center gap-2 text-zinc-400 text-sm">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        class="lucide lucide-lock"
                        ><rect width="18" height="11" x="3" y="11" rx="2" ry="2"
                        ></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg
                    >
                    <span>Tus datos están protegidos</span>
                </div>
                <div class="flex flex-col items-end gap-2 w-full md:w-auto">
                    <button
                        type="submit"
                        id="submit-btn"
                        form="quote-form"
                        disabled
                        class="w-full md:w-auto px-12 py-3 bg-[#FF8351] text-white font-bold uppercase tracking-wider text-sm hover:bg-[#ff6f38] transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        Enviar Cotización
                    </button>
                    <p id="error-products" class="text-red-500 text-xs hidden">
                        Debe haber mínimo 1 producto seleccionado
                    </p>
                </div>
            </div>
        </div>
    </div>

    {
        /* Data for client-side scripts to avoid inline scripts/TrustedScript errors */
    }
    <div
        id="cart-data"
        class="hidden"
        data-products={JSON.stringify(productsData)}
        data-images={JSON.stringify(imageMap)}
        data-api-key={FORM_API_KEY}
    >
    </div>
</section>

<script>
    import { quoteSchema } from "../lib/schemas";

    // Access data from DOM to avoid TrustedScript errors from define:vars
    const dataEl = document.getElementById("cart-data");
    const products = dataEl
        ? JSON.parse(dataEl.getAttribute("data-products") || "[]")
        : [];
    const imageMap = dataEl
        ? JSON.parse(dataEl.getAttribute("data-images") || "{}")
        : {};
    const FORM_API_KEY = dataEl
        ? dataEl.getAttribute("data-api-key") || ""
        : "";

    const cartContainer = document.getElementById("cart-items-container");
    const emptyMessage = document.getElementById("empty-cart-message");
    const form = document.getElementById("quote-form") as HTMLFormElement;
    const submitBtn = document.getElementById(
        "submit-btn",
    ) as HTMLButtonElement;
    const errorProducts = document.getElementById("error-products");

    // Icons SVG strings for dynamic rendering
    const minusIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M5 12h14"/></svg>`;
    const plusIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M5 12h14"/><path d="M12 5v14"/></svg>`;
    const xIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>`;

    function getCart() {
        return JSON.parse(localStorage.getItem("opplux_cart") || "[]");
    }

    function renderCart() {
        if (!cartContainer) return;

        const cart = getCart();

        if (cart.length === 0) {
            cartContainer.innerHTML = "";
            if (emptyMessage) {
                cartContainer.appendChild(emptyMessage);
                emptyMessage.classList.remove("hidden");
            }
            validateForm();
            return;
        }

        if (emptyMessage) emptyMessage.classList.add("hidden");
        cartContainer.innerHTML = "";

        cart.forEach((item: any) => {
            const product = products.find((p: any) => p.slug === item.slug);
            if (!product) return;

            // Get optimized image URL from map, preferring the _main version
            const mainImageKey = `${product.main_image}`;
            const imageUrl =
                imageMap[mainImageKey] ||
                imageMap[product.main_image] ||
                "/imgs/cart/no-image.png";
            const fallbackUrl = "/imgs/cart/no-image.png";

            const itemEl = document.createElement("div");
            itemEl.className =
                "cart-item bg-zinc-50 border border-zinc-200 p-4 md:p-6 flex flex-col md:flex-row md:items-center gap-4 md:gap-8 hover:border-[#FF8351]/50 transition-all duration-300";
            itemEl.dataset.slug = item.slug;

            itemEl.innerHTML = `
                <div class="flex items-center gap-4 md:gap-6 md:flex-1">
                    <div class="w-20 h-20 bg-white rounded overflow-hidden flex-shrink-0">
                        <img
                            src="${imageUrl}"
                            alt="${product.name}"
                            class="w-full h-full object-contain product-img"
                            data-fallback="${fallbackUrl}"
                        />
                    </div>

                    <div class="flex-1">
                        <h3 class="text-black font-bold uppercase tracking-wide leading-tight mb-1">
                            ${product.name}
                        </h3>
                        <p class="text-xs text-zinc-400">${product.led_power || ""}</p>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:flex md:items-center gap-4 md:gap-6">
                    <div class="min-w-[100px]">
                        <p class="text-xs text-zinc-400 mb-1">
                            Flujo luminoso
                        </p>
                        <p class="text-black font-bold text-sm">
                            ${product.max_luminous_flux}
                        </p>
                    </div>

                    <div class="min-w-[100px]">
                        <p class="text-xs text-zinc-400 mb-1">Garantía</p>
                        <p class="text-black font-bold text-sm">
                            ${product.warranty || "N/A"}
                        </p>
                    </div>
                </div>

                <div class="flex items-center justify-between md:justify-end gap-4 pt-3 md:pt-0 border-t md:border-t-0 border-zinc-200">
                    <div class="flex items-center gap-2">
                        <button
                            class="decrease-qty w-8 h-8 rounded-full border border-zinc-300 hover:border-[#FF8351] flex items-center justify-center transition-colors text-zinc-600 hover:text-[#FF8351]"
                            aria-label="Disminuir cantidad"
                        >
                            ${minusIcon}
                        </button>
                        <span class="qty-display text-black min-w-[40px] text-center font-semibold">
                            ${item.quantity}
                        </span>
                        <button
                            class="increase-qty w-8 h-8 rounded-full border border-zinc-300 hover:border-[#FF8351] flex items-center justify-center transition-colors text-zinc-600 hover:text-[#FF8351]"
                            aria-label="Aumentar cantidad"
                        >
                            ${plusIcon}
                        </button>
                    </div>

                    <button
                        class="remove-item w-8 h-8 rounded-full bg-zinc-200 hover:bg-red-500 flex items-center justify-center transition-colors text-zinc-600 hover:text-white"
                        aria-label="Eliminar producto"
                    >
                        ${xIcon}
                    </button>
                </div>
            `;

            cartContainer.appendChild(itemEl);

            // Add error listener to image manually to avoid inline script (TrustedScript error)
            const img = itemEl.querySelector(
                ".product-img",
            ) as HTMLImageElement;
            if (img) {
                img.addEventListener(
                    "error",
                    () => {
                        const fallback = img.getAttribute("data-fallback");
                        if (fallback) img.src = fallback;
                    },
                    { once: true },
                );
            }
        });
        validateForm();
    }

    function validateForm() {
        if (!form) return;

        const formData = new FormData(form);
        const values = {
            name: formData.get("name") as string,
            email: formData.get("email") as string,
            country: formData.get("country") as string,
            phone: formData.get("phone") as string,
            company: formData.get("company") as string,
            message: formData.get("message") as string,
            department: formData.get("department") as string,
        };

        const result = quoteSchema.safeParse(values);
        const cart = getCart();
        const isCartValid = cart.length > 0;

        // Update error messages
        const fields = [
            "name",
            "email",
            "country",
            "phone",
            "company",
            "message",
        ];
        fields.forEach((field) => {
            const errorEl = document.getElementById(`error-${field}`);
            const inputEl = document.getElementById(field);

            if (errorEl && inputEl) {
                const fieldError = !result.success
                    ? result.error.issues.find((i) => i.path[0] === field)
                    : null;
                if (fieldError && (inputEl as any).value.length > 0) {
                    errorEl.textContent = fieldError.message;
                    errorEl.classList.remove("hidden");
                    inputEl.classList.add("border-red-500");
                    inputEl.classList.remove("border-zinc-200");
                } else {
                    errorEl.classList.add("hidden");
                    inputEl.classList.remove("border-red-500");
                    if ((inputEl as any).value.length > 0) {
                        inputEl.classList.add("border-green-500");
                    } else {
                        inputEl.classList.remove("border-green-500");
                        inputEl.classList.add("border-zinc-200");
                    }
                }
            }
        });

        if (errorProducts) {
            if (!isCartValid) {
                errorProducts.classList.remove("hidden");
            } else {
                errorProducts.classList.add("hidden");
            }
        }

        submitBtn.disabled = !result.success || !isCartValid;
    }

    // Initial render
    renderCart();

    if (cartContainer) {
        cartContainer.addEventListener("click", (e) => {
            const target = e.target as HTMLElement;
            const itemRow = target.closest(".cart-item") as HTMLElement;

            if (!itemRow) return;

            const slug = itemRow.dataset.slug;
            const qtyDisplay = itemRow.querySelector(".qty-display");

            let cart = getCart();
            const itemIndex = cart.findIndex((i: any) => i.slug === slug);

            if (itemIndex === -1) return;

            let currentQty = cart[itemIndex].quantity;

            if (target.closest(".increase-qty")) {
                currentQty++;
                cart[itemIndex].quantity = currentQty;
                if (qtyDisplay) qtyDisplay.textContent = currentQty.toString();
                localStorage.setItem("opplux_cart", JSON.stringify(cart));
            }

            if (target.closest(".decrease-qty")) {
                if (currentQty > 1) {
                    currentQty--;
                    cart[itemIndex].quantity = currentQty;
                    if (qtyDisplay)
                        qtyDisplay.textContent = currentQty.toString();
                    localStorage.setItem("opplux_cart", JSON.stringify(cart));
                }
            }

            if (target.closest(".remove-item")) {
                itemRow.style.opacity = "0";
                itemRow.style.transform = "translateX(-20px)";

                cart.splice(itemIndex, 1);
                localStorage.setItem("opplux_cart", JSON.stringify(cart));
                window.dispatchEvent(new CustomEvent("add-to-cart"));

                setTimeout(() => {
                    renderCart();
                }, 300);
            }
        });
    }

    if (form) {
        form.addEventListener("input", validateForm);
        form.addEventListener("change", validateForm);

        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            // Estado de carga
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = `
                <span class="flex items-center justify-center gap-2">
                    <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Enviando...
                </span>
            `;

            const formData = new FormData(form);
            const formValues = Object.fromEntries(formData.entries());

            // Honeypot check
            if (formValues.department) {
                console.log("Bot detected via honeypot");
                setTimeout(() => {
                    alert(
                        "¡Cotización enviada con éxito! Nos pondremos en contacto pronto.",
                    );
                    form.reset();
                    localStorage.removeItem("opplux_cart");
                    window.dispatchEvent(new CustomEvent("add-to-cart"));
                    renderCart();
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                }, 1000);
                return;
            }

            const cart = getCart();
            const cartItems = cart.map((item: any) => {
                const product = products.find((p: any) => p.slug === item.slug);
                return {
                    producto: product ? product.name : item.slug,
                    cantidad: item.quantity,
                };
            });

            const submissionData = {
                ...formValues,
                productos: cartItems,
                fecha_solicitud: new Date().toISOString(),
            };

            try {
                const response = await fetch(
                    "https://lively-firefly-3744.alfonsodjimenez2003.workers.dev/",
                    {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "x-form-key": FORM_API_KEY,
                        },
                        body: JSON.stringify(submissionData),
                    },
                );

                // El worker siempre devuelve 200 {success: true} para despistar bots,
                // pero aquí confiamos en que si llegó el 200 es porque se procesó.
                if (response.ok) {
                    alert(
                        "¡Cotización enviada con éxito! Nos pondremos en contacto pronto.",
                    );
                    form.reset();
                    localStorage.removeItem("opplux_cart");
                    window.dispatchEvent(new CustomEvent("add-to-cart"));
                    renderCart();
                } else {
                    throw new Error("Error en el servidor");
                }
            } catch (error) {
                console.error("Error al enviar:", error);
                alert(
                    "Hubo un problema al enviar tu cotización. Por favor, inténtalo de nuevo o contáctanos directamente.",
                );
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
                validateForm();
            }
        });
    }

    // Country selection handler
    const countrySelect = document.getElementById(
        "country",
    ) as HTMLSelectElement;

    if (countrySelect) {
        countrySelect.addEventListener("change", () => {
            validateForm();
        });
    }
</script>
