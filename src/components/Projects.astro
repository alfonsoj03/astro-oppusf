---
import { ArrowRight, MapPin } from "lucide-astro";
import { supabase } from "../lib/supabase";
import placeholderImg from "../assets/cedis-1.png";

// Import all images from assets directory
const images = import.meta.glob<{ default: ImageMetadata }>(
    "/src/assets/*.{png,jpg,jpeg,webp}",
    { eager: true },
);

// Fetch latest 3 success cases from Supabase
const { data: successCasesData, error } = await supabase
    .from("success_cases")
    .select(
        `
        id,
        title,
        description,
        location,
        slug,
        main_image,
        project_types (
            name
        )
    `,
    )
    .order("created_at", { ascending: false })
    .limit(3);

if (error) {
    console.error("Error fetching projects for home:", error);
}

// Transform data to match component expectations
const projects = (successCasesData || []).map((sc) => {
    // Try to resolve gallery image from assets
    let resourceSrc = sc.main_image;
    if (resourceSrc && !resourceSrc.startsWith("http")) {
        const imagePath = `/src/assets/${resourceSrc}.png`;
        const imageModule = images[imagePath];

        if (imageModule && imageModule.default) {
            resourceSrc = imageModule.default.src;
        } else {
            // Fallback if not found
            resourceSrc = placeholderImg.src;
        }
    } else if (!resourceSrc) {
        resourceSrc = placeholderImg.src;
    }

    return {
        id: sc.id,
        category: (sc.project_types as any)?.name || "Sin categoría",
        title: sc.title,
        description: sc.description,
        location: sc.location,
        image: resourceSrc,
        slug: sc.slug,
    };
});
---

<section class="py-12 lg:py-24 bg-white text-zinc-900 relative overflow-hidden">
    <div class="container mx-auto px-6 relative z-10">
        {/* Header */}
        <div
            class="flex flex-col md:flex-row md:items-end justify-between gap-8 mb-10 lg:mb-16"
        >
            <div class="space-y-4">
                <span
                    class="text-[#FF8351] text-sm font-bold tracking-widest uppercase"
                >
                    Casos de Éxito
                </span>
                <h2
                    class="text-4xl lg:text-5xl font-bold tracking-tight text-zinc-900"
                >
                    Proyectos Destacados
                </h2>
            </div>

            <a
                href="/casos-de-exito"
                class="hidden md:flex items-center gap-2 text-zinc-600 hover:text-[#FF8351] transition-colors font-medium group"
            >
                <span>Ver portafolio completo</span>
                <ArrowRight
                    size={16}
                    class="group-hover:translate-x-1 transition-transform"
                />
            </a>
        </div>

        {/* Grid */}
        <div class="grid grid-cols-1 md:grid-cols-3 gap-x-8 gap-y-12">
            {
                projects.map((project, index) => (
                    <div
                        class="project-card group flex flex-col opacity-0 translate-y-8 transition-all duration-700 ease-out md:bg-zinc-50 lg:bg-transparent md:border md:border-zinc-200 lg:border-none md:hover:border-zinc-300"
                        style={`transition-delay: ${index * 100}ms`}
                    >
                        {/* Image Area */}
                        <div class="relative aspect-[4/3] w-full overflow-hidden rounded-2xl md:rounded-none lg:rounded-2xl lg:mb-6 mb-6 md:mb-0">
                            <img
                                src={project.image}
                                alt={project.title}
                                class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
                            />
                            {/* Category Tag */}
                            <div class="absolute top-4 left-4">
                                <span class="bg-white/90 backdrop-blur-sm text-zinc-900 text-xs font-bold px-3 py-1.5 rounded-full">
                                    {project.category}
                                </span>
                            </div>
                        </div>

                        {/* Content Area */}
                        <div class="flex flex-col flex-1 mb-3 md:p-6 lg:p-0 lg:mb-3">
                            {/* Location - Above title on MD, below description on others */}
                            <div class="hidden md:flex lg:hidden items-center gap-2 text-zinc-400 md:text-zinc-500 text-xs mb-2">
                                <MapPin size={14} />
                                <span>{project.location}</span>
                            </div>

                            <h3 class="md:text-lg lg:text-2xl text-2xl font-bold text-zinc-900 md:text-zinc-900 lg:text-zinc-900 leading-tight md:mb-2 lg:mb-4 mb-4 min-h-[3.5rem]">
                                {project.title}
                            </h3>

                            <p class="md:hidden lg:block block text-zinc-500 text-sm leading-relaxed mb-6 flex-1">
                                {project.description}
                            </p>

                            <div class="flex flex-row md:flex-col lg:flex-row items-center justify-between mt-auto pt-4 border-t border-zinc-100 md:border-t-0 md:pt-0 lg:border-t lg:pt-4 lg:border-zinc-100">
                                <div class="flex md:hidden lg:flex items-center gap-2 text-zinc-400 text-xs">
                                    <MapPin size={14} />
                                    <span>{project.location}</span>
                                </div>

                                <a
                                    href={`/casos-de-exito/${project.slug}`}
                                    class="md:bg-transparent lg:bg-[#FF8351] bg-[#FF8351] hover:bg-[#e06b3d] md:hover:bg-transparent md:hover:text-[#e06b3d] md:text-[#FF8351] lg:text-white text-white text-sm font-bold px-3 py-1 lg:px-3 lg:py-1 md:px-0 md:py-0 rounded-full transition-colors flex items-center gap-2 md:w-full md:justify-start lg:w-auto lg:justify-center"
                                >
                                    Ver detalles
                                    <ArrowRight size={14} />
                                </a>
                            </div>
                        </div>
                    </div>
                ))
            }
        </div>

        {/* Mobile "View All" Button */}
        <div class="mt-12 flex md:hidden justify-center">
            <a
                href="/casos-de-exito"
                class="text-zinc-900 font-bold border-b-2 border-[#FF8351] pb-1"
            >
                Ver todos los proyectos
            </a>
        </div>
    </div>
</section>

<script>
    const observerOptions = {
        root: null,
        rootMargin: "0px",
        threshold: 0.1,
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
            if (entry.isIntersecting) {
                entry.target.classList.remove("opacity-0", "translate-y-8");
                observer.unobserve(entry.target);
            }
        });
    }, observerOptions);

    document.querySelectorAll(".project-card").forEach((card) => {
        observer.observe(card);
    });
</script>
